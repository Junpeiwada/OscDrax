# OscDrax - iOS オシレーターアプリ仕様書

## 概要
- **アプリ名**: OscDrax
- **プラットフォーム**: iOS (最新版対応)
- **開発フレームワーク**: SwiftUI + Liquidglass
- **画面方向**: 縦画面のみ対応
- **UI特徴**: Liquidglassによる流体的でモダンなUI（全UIコンポーネントに適用）
- **パッケージ管理**: Swift Package Manager (SPM)

## 主要機能

### 1. トラック機能
- 4つの独立したトラックを提供
- 各トラックは個別に制御可能
- トラック切り替えは画面下部のタブ（1, 2, 3, 4）で実行

### 2. 波形表示・編集
- 画面上部に大きな波形表示エリア
- 各トラックごとに独立した波形を描画・表示
- **手描き波形**：
  - タッチジェスチャーで自由に波形を描画可能
  - 描画中も音声は継続再生
  - 描いた波形は自動的に周期波形として認識
  - クリアボタンで波形をリセット
- プリセット波形：
  - サイン波（sin）
  - 三角波（triangle）
  - 矩形波（square）
- プリセット選択：
  - Popoverで表示
  - プリセット選択時は手描き波形をクリア

### 3. 音声制御
- **周波数調整**:
  - 範囲: 20Hz - 20,000Hz
  - スライダーで調整
  - 発音中でもリアルタイムで滑らかに変更可能
  - **ポルタメント機能**: 周波数変更時に前の周波数から新しい周波数へ滑らかに遷移（グライド効果）
  - 遷移時間は調整可能（0ms～1000ms）
  - ※ポルタメント：音程を滑らかに変化させる演奏技法

- **ボリューム調整**:
  - 範囲: 0 - 100%
  - スライダーで調整
  - 各トラック個別に設定可能

### 4. 再生制御
- 各トラックの再生ボタンで該当トラックの発音ON/OFF
- トラックごとに独立して発音制御
- 複数トラック同時発音可能
- アプリ終了時は自動的に音声停止

### 5. データ永続化
- 波形データはJSON形式で保存
- アプリ終了後も設定を保持
- 次回起動時に前回の状態を復元

## UI レイアウト
```
+------------------------+
|  [preset] [clear]      | <- プリセット選択(Popover)、クリアボタン
|                        |
|   +----------------+   |
|   |                |   | <- 波形表示エリア
|   |    波形描画     |   |  （タッチで描画可能）
|   |                |   |
|   +----------------+   |
|                        |
| Hz    [=========O==]   | <- 周波数スライダー
|                        |
| Volume [======O====]   | <- ボリュームスライダー
|                        |
|      [  ▶ Play  ]     | <- 再生ボタン（トラック個別）
|                        |
| [1] [2] [3] [4]       | <- トラックタブ（下部）
+------------------------+
```

## 技術仕様

### 音声処理
- **フレームワーク**: AVAudioEngine
- **サンプリングレート**: 44,100Hz
- **ビット深度**: 16bit
- **チャンネル**: モノラル
- **バッファサイズ**: 512サンプル（約11.6msレイテンシ）
- **目標レイテンシ**: 100ms以内

### マルチスレッドアーキテクチャ
- **メインスレッド**: UI更新、ユーザー入力処理
- **オーディオスレッド**: リアルタイム音声合成（別スレッド）
- **パラメータ更新**: 60Hz（16.7msごと）

### 音声合成エンジン設計
```swift
// 音声エンジンクラス（別スレッドで動作）
class AudioEngine {
    - OscillatorTrack × 4
    - ParameterQueue（ロックフリー）
    - MixerModule
}

// 各トラッククラス
class OscillatorTrack {
    - waveformTable: [Float] (512ポイント)
    - frequency: Float (20-20000Hz)
    - volume: Float (0.0-1.0)
    - phase: Float (独立位相)
    - portamentoTime: Float
}

// パラメータ通信
struct AudioParameter {
    - trackId: Int
    - parameterType: ParameterType
    - value: Float
    - timestamp: TimeInterval
}
```

### 波形処理
- **波形テーブルサイズ**: 512ポイント
- **補間方法**: 線形補間
- **手描き波形**: タッチ座標を512ポイントに正規化

### ミキシング処理
- **方式**: 加算合成＋ソフトクリッピング
- **計算式**:
  ```
  mixed = (track1 + track2 + track3 + track4) / 4
  output = tanh(mixed * 0.7)
  ```
- **各トラック位相**: 独立管理

### データ保存
- **形式**: JSON
- **保存場所**: アプリのDocumentsディレクトリ
- **保存内容**:
  ```json
  {
    "tracks": [
      {
        "id": 1,
        "waveformType": "custom",  // "sine", "triangle", "square", "custom"
        "waveformData": [0.0, 0.5, 1.0, ...],  // 手描き波形のサンプルデータ
        "frequency": 440.0,
        "volume": 0.5,
        "isPlaying": false,
        "portamentoTime": 100  // ポルタメント時間（ms）
      }
    ]
  }
  ```

### 対応デバイス
- iPhone (iOS 17.0以上)
- iPad対応は将来的に検討

## 初期値設定
- **初期波形**: サイン波（sin）
- **初期周波数**: 440Hz (A4音)
- **初期ボリューム**: 50%
- **初期ポルタメント時間**: 0ms（即座に変化）
- **初期再生状態**: 停止

## 開発優先順位
1. 基本的な音声再生機能
2. 波形表示
3. トラック切り替え
4. プリセット波形
5. 手描き波形機能
6. データ永続化