# OscDrax - iOS オシレーターアプリ仕様書

## 概要
- **アプリ名**: OscDrax
- **プラットフォーム**: iOS (iOS 18.5以上)
- **開発フレームワーク**: SwiftUI + AVAudioEngine
- **画面方向**: 縦画面のみ対応
- **UI特徴**: Liquidglassによる流体的でモダンなUI
- **最小デプロイメントターゲット**: iOS 18.5

## 主要機能

### 1. トラック機能
- 4つの独立したトラックを提供
- 各トラックは個別に制御可能
- トラック切り替えは画面下部のタブで実行
- 各タブにミニ波形プレビュー表示（実装中）

### 2. 波形表示・編集
- 画面上部に大きな波形表示エリア
- 各トラックごとに独立した波形を描画・表示
- **手描き波形**：
  - タッチジェスチャーで自由に波形を描画可能
  - 描画中も音声は継続再生
  - 描いた波形は自動的に周期波形として認識
  - クリアボタンで波形をリセット
- **プリセット波形**：
  - サイン波（Sin）
  - 三角波（Triangle）
  - 矩形波（Square）
  - ノコギリ波（Sawtooth）
- プリセット選択：
  - セグメントコントロールで即座に切り替え
  - プリセット選択時は手描き波形をクリア

### 3. 音声制御
- **周波数調整**:
  - 範囲: 20Hz - 20,000Hz（対数スケール）
  - カスタムスライダーで調整（どこをタッチしても即座に反応）
  - 発音中でもリアルタイムで滑らかに変更可能
  - **ポルタメント機能**: 周波数変更時に前の周波数から新しい周波数へ滑らかに遷移
  - 遷移時間は調整可能（0ms～1000ms）
  - 指数関数的な遷移で自然な音の変化を実現

- **ボリューム調整**:
  - 範囲: 0 - 100%
  - カスタムスライダーで調整
  - 各トラック個別に設定可能

### 4. 音階機能（スケール）
- **対応スケール**:
  - なし（None）- 自由な周波数設定
  - クロマチック（Chromatic）- 半音階
  - メジャー（Major）- 長音階
  - マイナー（Minor）- 短音階
  - ペンタトニック（Pentatonic）- 五音音階
  - ブルース（Blues）- ブルース音階
- 選択したスケールの音程に自動的にクオンタイズ
- リアルタイムで最も近い音程にスナップ

### 5. ハーモニー機能
- **マスタートラック選択**: トラック1をマスターとして設定可能
- **対応コードタイプ**:
  - メジャー（Major）: Root, 3rd, 5th, Oct
  - マイナー（Minor）: Root, m3, 5th, Oct
  - セブンス（7th）: Root, 3rd, 5th, b7
  - マイナーセブンス（m7）: Root, m3, 5th, b7
  - メジャーセブンス（M7）: Root, 3rd, 5th, 7th
  - サスフォー（sus4）: Root, 4th, 5th, Oct
  - ディミニッシュ（dim）: Root, m3, b5, bb7
  - パワーコード（Power）: Root, 5th, Oct, 2Oct
- ハーモニー有効時、各トラックに自動的に音程を割り当て
- マスタートラックの周波数変更に追従

### 6. ビブラート機能
- 周波数が500ms以上安定した後に自動的に適用
- ビブラート速度: 5Hz
- ビブラート深度: 1%の周波数変調
- トラックごとにON/OFF可能
- ポルタメント中は自動的に無効化

### 7. 再生制御
- 各トラックの再生ボタンで該当トラックの発音ON/OFF
- トラックごとに独立して発音制御
- 複数トラック同時発音可能
- フェードイン/フェードアウト（50ms）でクリック音を防止

### 8. データ永続化
- 波形データはJSON形式で保存
- アプリ終了後も設定を保持
- 次回起動時に前回の状態を復元

## UI レイアウト
```
+------------------------+
|      OscDrax          | <- アプリタイトル
|                        |
|   +----------------+   |
|   |                |   | <- 波形表示エリア
|   |    波形描画     |   |  （タッチで描画可能）
|   |                |   |
|   +----------------+   |
|                        |
| [プリセット選択]        | <- セグメントコントロール
| [Clear]               | <- クリアボタン
|                        |
| Frequency [====O===]   | <- 周波数スライダー（対数）
| Scale: [Chromatic ▼]  | <- スケール選択
|                        |
| Harmony               |
| Master Track □        | <- マスタートラック設定
| Chord: [Major ▼]      | <- コード選択
|                        |
| Volume [======O====]   | <- ボリュームスライダー
| Portamento [==O====]   | <- ポルタメントスライダー
| Vibrato: ON/OFF       | <- ビブラート切り替え
|                        |
|      [  ▶ Play  ]     | <- 再生ボタン
|                        |
| [🌊1] [🌊2] [🌊3] [🌊4] | <- トラックタブ（ミニ波形付き）
+------------------------+
```

## 技術仕様

### 音声処理
- **フレームワーク**: AVAudioEngine + AVAudioSourceNode
- **サンプリングレート**: 44,100Hz
- **ビット深度**: 32bit float
- **チャンネル**: モノラル
- **バッファサイズ**: 512サンプル
- **レイテンシ**: < 50ms

### スレッドセーフティ機構
- **NSLock**: パラメータの排他制御
- **二重バッファリング**: 波形データの更新
- **デバウンス処理**:
  - 周波数・ボリューム: 5ms
  - 波形データ: 10ms
  - 再生/停止: 即座に反映

### 音声合成エンジン設計
```swift
// メインエンジン
class AudioEngine: ObservableObject {
    - AVAudioEngine
    - AVAudioMixerNode
    - OscillatorNode × 4
}

// オシレータノード（リアルタイムスレッドで動作）
class OscillatorNode {
    - AVAudioSourceNode (オーディオコールバック)
    - waveformBuffer (二重バッファリング)
    - frequency/volume (アトミック変数)
    - portamentoTime (スレッドセーフ)
    - vibratoEnabled (スレッドセーフ)
}

// パラメータ管理
class AudioManager {
    - Combineによる監視
    - debounce処理
    - ハーモニー計算
}
```

### 波形処理
- **波形テーブルサイズ**: 512ポイント
- **補間方法**: 線形補間
- **手描き波形**: タッチ座標を512ポイントに正規化
- **プリセット波形**: 数学的に生成

### ミキシング処理
- **方式**: 加算合成＋ソフトクリッピング
- **計算式**:
  ```
  mixed = (track1 + track2 + track3 + track4) / 4
  output = tanh(mixed * 0.7)
  ```
- **各トラック位相**: 独立管理

### データ保存
- **形式**: JSON (Codable)
- **保存場所**: アプリのDocumentsディレクトリ
- **保存内容**:
  ```json
  {
    "tracks": [
      {
        "id": 1,
        "waveformType": "custom",
        "waveformData": [0.0, 0.5, 1.0, ...],
        "frequency": 440.0,
        "volume": 0.5,
        "isPlaying": false,
        "portamentoTime": 100,
        "harmonyEnabled": true,
        "assignedInterval": "3rd",
        "isHarmonyMaster": true,
        "vibratoEnabled": false,
        "scaleType": "major"
      }
    ]
  }
  ```

### 起動画面（LaunchScreen）
- **実装方式**: LaunchScreen.storyboard
- **画像**: SplashImage（アプリUIのプレビュー）
- **背景色**: ダークグレー (#1A1A1A)
- **注意事項**: iOSの強力なキャッシュのため、変更時はビルド番号の増加が必要

### 対応デバイス
- iPhone (iOS 18.5以上)
- iPad（基本対応、UIは縦画面最適化）

## 初期値設定
- **初期波形**: サイン波（Sin）
- **初期周波数**: 440Hz (A4音)
- **初期ボリューム**: 50%
- **初期ポルタメント時間**: 0ms
- **初期スケール**: なし（None）
- **初期コード**: メジャー（Major）
- **初期ビブラート**: OFF
- **初期再生状態**: 停止

## 実装済み機能
1. ✅ 基本的な音声再生機能
2. ✅ 波形表示・手描き機能
3. ✅ 4トラック切り替え
4. ✅ プリセット波形（Sin, Triangle, Square, Sawtooth）
5. ✅ データ永続化（JSON）
6. ✅ ポルタメント機能
7. ✅ スケールクオンタイズ
8. ✅ ハーモニー自動生成
9. ✅ ビブラート機能
10. ✅ スレッドセーフティ対策
11. ✅ カスタムスライダー（即座に反応）
12. ✅ LaunchScreen設定

## 今後の拡張予定
- MiniWaveformView（トラックタブ内のプレビュー）
- MIDI対応
- エフェクト処理（リバーブ、ディレイ）
- 録音・エクスポート機能
- 横画面対応